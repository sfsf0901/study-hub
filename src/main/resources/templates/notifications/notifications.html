<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head th:replace="~{layout/fragments.html :: head}">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
<div th:replace="~{layout/fragments.html :: main-nav}"></div>

<div class="container">
  <div class="row justify-content-center my-5">
    <div class="col-3">
      <!-- ì‚¬ì´ë“œ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div th:replace="~{notifications/layout/notificationSideNav.html :: notificationSideNav(currentMenu='notifications')}"></div>
    </div>

    <div class="col-7">
      <form id="deleteForm" th:action="@{/notifications/delete}" method="post">
        <div class="card">
          <div class="card-header">
            <small>ì „ì²´ ì•Œë¦¼ì„ í™•ì¸í•˜ì„¸ìš”.</small>
          </div>

          <ul class="list-group list-group-flush">
            <li th:if="${notifications.size() == 0}" class="list-group-item">
              <div class="my-3 text-muted d-flex w-100 justify-content-center">
                <span>ì•Œë¦¼ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
              </div>
            </li>

            <li th:each="notification : ${notifications}" class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" th:id="'checkbox-' + ${notification.id}" th:value="${notification.id}" name="notificationIds" style="cursor: pointer;">
                  <div class="notification-title"
                       th:data-id="${notification.id}"
                       th:data-title="${notification.title}"
                       th:data-message="${notification.message}"
                       th:data-studyTitle="${notification.studyTitle}"
                       th:data-link="${notification.link}"
                       data-bs-toggle="modal"
                       data-bs-target="#exampleModal"
                       style="cursor: pointer;">
                    <strong th:if="${notification.checked == false}">
                      <span th:text="${notification.title}"></span>
                    </strong>
                    <span th:if="${notification.checked == true}" th:text="${notification.title}"></span>
                  </div>
                </div>
                <small class="fromNow text-muted" th:text="${#temporals.format(notification.createdDate, 'yyyy-MM-dd HH:mm')}">3 days ago</small>
              </div>
            </li>
          </ul>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalTitle">ì•Œë¦¼ ì œëª©</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="modalBody">
                ì•Œë¦¼ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-secondary mt-3" id="deleteButton">ì‚­ì œ</button>
      </form>
    </div>
  </div>
</div>

<!-- âœ… ì½ìŒ ì²˜ë¦¬ìš© hidden form -->
<form id="markAsReadForm" th:action="@{/notification/check}" method="post">
  <input type="hidden" name="notificationId" id="notificationIdInput">
  <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>  <!-- âœ… CSRF í† í° ì¶”ê°€ -->
</form>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    let currentNotificationId = null; // í˜„ì¬ í´ë¦­ëœ ì•Œë¦¼ ID ì €ì¥

    document.querySelectorAll(".notification-title").forEach(function(titleElement) {
      titleElement.addEventListener("click", function(event) {
        const clickedElement = event.currentTarget;
        if (!clickedElement) {
          console.error("ğŸš¨ notification-titleì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
          return;
        }

        // âœ… í´ë¦­ëœ ì•Œë¦¼ì˜ ID ê°€ì ¸ì˜¤ê¸°
        currentNotificationId = clickedElement.getAttribute("data-id");
        console.log("ğŸ“Œ í´ë¦­í•œ ì•Œë¦¼ ID:", currentNotificationId);

        if (!currentNotificationId) {
          console.error("ğŸš¨ notification-title ìš”ì†Œì— data-id ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // âœ… ëª¨ë‹¬ì— ë°ì´í„° ì—…ë°ì´íŠ¸
        const notificationTitle = clickedElement.getAttribute("data-title") || "ì œëª© ì—†ìŒ";
        const notificationMessage = clickedElement.getAttribute("data-message") || "ë‚´ìš© ì—†ìŒ";
        const studyTitle = clickedElement.getAttribute("data-studyTitle") || "ìŠ¤í„°ë”” ì •ë³´ ì—†ìŒ";
        const link = clickedElement.getAttribute("data-link") || "#";

        document.getElementById("modalTitle").textContent = notificationTitle;
        document.getElementById("modalBody").innerHTML = `
                <p>${notificationMessage}</p>
                <br>
                <p><strong>ìŠ¤í„°ë”” ì´ë¦„:</strong> ${studyTitle}</p>
                <p><a href="${link}" target="_blank">ìŠ¤í„°ë”” í˜ì´ì§€ë¡œ ì´ë™</a></p>
            `;
      });
    });

    // âœ… ëª¨ë‹¬ì´ ë‹«í ë•Œ ë™ê¸° ë°©ì‹ìœ¼ë¡œ ì½ìŒ ì²˜ë¦¬ ìš”ì²­ ë³´ë‚´ê¸°
    document.getElementById("exampleModal").addEventListener("hidden.bs.modal", function () {
      if (!currentNotificationId) return; // í´ë¦­ëœ ì•Œë¦¼ì´ ì—†ìœ¼ë©´ ë¬´ì‹œ

      console.log("âœ… ëª¨ë‹¬ ë‹«í˜! ì½ìŒ ì²˜ë¦¬ ìš”ì²­ ë³´ëƒ„:", currentNotificationId);

      // âœ… form ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const form = document.getElementById("markAsReadForm");
      const input = document.getElementById("notificationIdInput");

      if (!form || !input) {
        console.error("ğŸš¨ markAsReadForm ë˜ëŠ” notificationIdInputì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ!");
        return;
      }

      input.value = currentNotificationId; // âœ… ì•Œë¦¼ ID ì„¤ì •

      setTimeout(() => {
        console.log("âœ… form ì œì¶œ ì‹¤í–‰!");
        form.submit(); // âœ… ë™ê¸° ë°©ì‹ìœ¼ë¡œ form ì œì¶œ
      }, 300);
    });

    // âœ… ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒëœ ì•Œë¦¼ ì‚­ì œ
    document.getElementById("deleteButton").addEventListener("click", function() {
      const checkboxes = document.querySelectorAll(".form-check-input:checked");
      if (checkboxes.length === 0) {
        alert("ì‚­ì œí•  ì•Œë¦¼ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      if (confirm("ì„ íƒí•œ ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        document.getElementById("deleteForm").submit();
      }
    });
  });

</script>

</body>
</html>
